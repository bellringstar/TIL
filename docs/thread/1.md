# Java 스레드 생성 및 시작 프로세스의 상세 분석

## 1. Java 코드 레벨

### 1.1 스레드 객체 생성
Java에서 스레드 객체를 생성하는 방법은 크게 두 가지입니다:

a) Thread 클래스 상속:
```java
public class MyThread extends Thread {
    @Override
    public void run() {
        // 스레드에서 실행할 코드
    }
}

MyThread thread = new MyThread();
```

b) Runnable 인터페이스 구현:
```java
public class MyRunnable implements Runnable {
    @Override
    public void run() {
        // 스레드에서 실행할 코드
    }
}

Thread thread = new Thread(new MyRunnable());
```

### 1.2 스레드 시작
스레드 객체를 생성한 후, `start()` 메서드를 호출하여 스레드를 시작합니다:

```java
thread.start();
```

`start()` 메서드의 호출은 실제로 다음과 같은 복잡한 과정을 트리거합니다.

## 2. JVM 레벨

### 2.1 Thread 객체 초기화
`Thread` 객체가 생성될 때, JVM은 다음 작업을 수행합니다:

a) 메모리 할당: 힙(Heap) 영역에 `Thread` 객체를 위한 메모리를 할당합니다.

b) 필드 초기화:
- `threadStatus`: 초기값 0 (NEW 상태)
- `priority`: 부모 스레드의 우선순위를 상속 (기본값 NORM_PRIORITY)
- `daemon`: 부모 스레드의 데몬 상태를 상속

c) 스레드 그룹 설정: 부모 스레드의 스레드 그룹에 새 스레드를 추가합니다.

### 2.2 start() 메서드 실행
`start()` 메서드가 호출되면, 다음 단계가 실행됩니다:

a) 상태 검사: `threadStatus`가 0인지 확인하여 이미 시작된 스레드가 아닌지 검사합니다.

b) 스레드 등록: JVM의 스레드 관리자에 새 스레드를 등록합니다.

c) 네이티브 start0() 메서드 호출: JNI(Java Native Interface)를 통해 네이티브 `start0()` 메서드를 호출합니다.

### 2.3 JNI 및 네이티브 코드 실행
`start0()` 메서드는 JNI를 통해 다음 작업을 수행합니다:

a) OS 스레드 생성: 운영 체제의 스레드 생성 API를 호출합니다 (예: Linux의 `pthread_create`).

b) JVM 스레드 구조체 생성: `JavaThread` 구조체를 생성하고 초기화합니다.

c) 스레드 로컬 저장소(TLS) 설정: 스레드별 데이터를 저장할 TLS를 초기화합니다.

d) JNI 환경 설정: 새 스레드를 위한 JNIEnv 구조체를 초기화합니다.

### 2.4 JavaThread 초기화
`JavaThread` 구조체는 다음 정보를 포함합니다:

a) OS 스레드 식별자
b) Java Thread 객체에 대한 참조
c) 스레드 상태 정보
d) 동기화 관련 데이터 (예: parker, monitor 등)
e) 예외 처리 관련 정보

### 2.5 스레드 스택 설정
새 스레드를 위한 스택이 할당됩니다:

a) 스택 크기 결정: JVM 옵션 (-Xss)에 따라 결정되며, 기본값은 플랫폼에 따라 다릅니다 (일반적으로 512KB ~ 1MB).

b) 가드 페이지 설정: 스택 오버플로우를 감지하기 위한 가드 페이지를 스택의 끝에 배치합니다.

## 3. 운영 체제 레벨

### 3.1 OS 스레드 생성
운영 체제는 다음 작업을 수행하여 새 스레드를 생성합니다:

a) 스레드 컨텍스트 생성: 레지스터 세트, 프로그램 카운터 등을 포함한 스레드 컨텍스트를 초기화합니다.

b) 스택 할당: 커널 모드 스택과 사용자 모드 스택을 할당합니다.

c) 스레드 식별자 할당: 고유한 스레드 ID를 할당합니다.

### 3.2 스케줄링 설정
새 스레드를 위한 스케줄링 정보를 설정합니다:

a) 우선순위 설정: Java 우선순위를 OS 우선순위로 매핑합니다.
b) 실행 큐 추가: 스레드를 CPU의 실행 큐에 추가합니다.

## 4. 스레드 실행 시작

### 4.1 JVM으로의 제어 반환
OS가 스레드 생성을 완료하면, 제어권이 JVM으로 돌아옵니다.

### 4.2 run() 메서드 호출 준비
JVM은 새 스레드의 엔트리 포인트를 `Thread.run()` 메서드로 설정합니다.

### 4.3 스레드 상태 변경
스레드 상태가 NEW에서 RUNNABLE로 변경됩니다.

### 4.4 실행 시작
OS의 스케줄러에 의해 선택되면, 새 스레드가 실제로 실행을 시작하고 `run()` 메서드의 코드를 실행합니다.

## 결론

Java 스레드의 생성 및 시작 프로세스는 Java 코드 레벨부터 JVM 내부, 그리고 운영 체제 수준까지 복잡하고 다층적인 과정을 거칩니다. 이 과정은 메모리 관리, 운영 체제와의 상호 작용, JVM의 내부 구조 등 다양한 시스템 프로그래밍 개념을 포함하고 있습니다. 이러한 상세한 이해는 Java의 동시성 프로그래밍과 성능 최적화에 중요한 기반이 됩니다.